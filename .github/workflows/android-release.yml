name: Android Release

permissions:
  contents: write

on:
  push:
    tags:
      - '**[0-9]+.[0-9]+.[0-9]+*'

jobs:
  build-android:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: hiverra-portal

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Build Android Binary
        run: cargo ndk -t aarch64-linux-android --platform 28 build --release

      - name: Create Tarball & Checksum
        run: |
          mkdir -p dist/bundle
          cp target/aarch64-linux-android/release/portal dist/bundle/portal
          cp README.md LICENSE* dist/bundle/ || true
          
          cd dist
          TAR_NAME="hiverra-portal-aarch64-linux-android.tar.gz"
          tar -czf "$TAR_NAME" -C bundle .
          sha256sum "$TAR_NAME" > "$TAR_NAME.sha256"
          cd ..

      - name: Generate Installer Script
        run: |
          cat > dist/hiverra-portal-android-installer.sh <<EOF
          #!/bin/sh
          set -e
          REPO="Spectra010s/portal"
          TAG="${{ github.ref_name }}"
          BINARY_NAME="hiverra-portal-aarch64-linux-android.tar.gz"
          URL="https://github.com/\$REPO/releases/download/\$TAG/\$BINARY_NAME"

          echo "Installing portal (\$TAG) for Android..."

          FILE="\$TMP_DIR/hiverra-portal.tar.gz"
          TMP_DIR=\$(mktemp -d "\$PREFIX/tmp/portal-install-XXXXXX")

          curl -sSfL "\$URL" -o "\$FILE"
          curl -sSfL "\$URL.sha256" -o "\$TMP_DIR/check.sha256"

          EXPECTED_HASH=\$(awk '{print \$1}' "\$TMP_DIR/check.sha256")
          ACTUAL_HASH=\$(sha256sum "\$FILE" | awk '{print \$1}')

          if [ "\$EXPECTED_HASH" != "\$ACTUAL_HASH" ]; then
              echo "ERROR: Checksum mismatch!"
              exit 1
          fi

          tar -xzf "\$FILE" -C "\$TMP_DIR"
          mv "\$TMP_DIR/portal" "\$PREFIX/bin/portal"
          chmod +x "\$PREFIX/bin/portal"
          rm -rf "\$TMP_DIR"

          echo "Success! Type 'portal' to start."
          EOF

          chmod +x dist/hiverra-portal-android-installer.sh

      - name: Wait for cargo-dist Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for i in {1..20}; do
            if gh release view ${{ github.ref_name }} > /dev/null 2>&1; then
              echo "Release found!"
              exit 0
            fi
            sleep 30
          done
          echo "Release not found."
          exit 1

      - name: Upload Android Artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.ref_name }} \
            dist/hiverra-portal-aarch64-linux-android.tar.gz \
            dist/hiverra-portal-aarch64-linux-android.tar.gz.sha256 \
            dist/hiverra-portal-android-installer.sh \
            --clobber

      - name: Edit Release Body
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REF: ${{ github.ref_name }}
        run: |
          gh release view "$REF" --json body --jq '.body' > body.md

          # Skip if already exists
          if grep -q "Android (Termux)" body.md; then
            echo "Android section already present."
            exit 0
          fi

          # Create Android section
          cat > android_section.md <<EOF

          ### Install prebuilt binaries via shell script (Android / Termux)
            
          \`\`\`sh
          curl -LsSf \
          https://github.com/Spectra010s/portal/releases/download/$REF/hiverra-portal-android-installer.sh | sh
          \`\`\`
           
          EOF

          # Inject AFTER closing npm code fence
          awk '
          BEGIN { in_npm=0; fence_count=0 }

          /^### Install via npm/ {
              in_npm=1
              print
              next
          }

          in_npm && /^```/ {
              fence_count++
              print
              if (fence_count == 2) {
                  system("cat android_section.md")
                  in_npm=0
              }
              next
          }

          { print }
          ' body.md > new_body.md

          mv new_body.md body.md

          # Fallback: if npm section wasn't found
          if ! grep -q "Android (Termux)" body.md; then
            awk '
            /^## Download/ {
              system("cat android_section.md")
            }
            { print }
            ' body.md > new_body.md
            mv new_body.md body.md
          fi

          # Remove any previous Android table row
          sed -i '/aarch64-linux-android\.tar\.gz/d' body.md

          # Create Android table row
          cat > table_row.md <<EOF
          | [hiverra-portal-aarch64-linux-android.tar.gz](https://github.com/Spectra010s/portal/releases/download/$REF/hiverra-portal-aarch64-linux-android.tar.gz) | Android (Termux) | [checksum](https://github.com/Spectra010s/portal/releases/download/$REF/hiverra-portal-aarch64-linux-android.tar.gz.sha256) |
          EOF

          # Insert table row after Linux tar.xz entry
          sed -i "/x86_64-unknown-linux-gnu\.tar\.xz/r table_row.md" body.md

          gh release edit "$REF" --notes-file body.md

          rm -f android_section.md table_row.md