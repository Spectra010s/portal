name: Android Release
permissions:
  contents: write

on:
  push:
    tags:
      - '**[0-9]+.[0-9]+.[0-9]+*'

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Install Android NDK
        run: |
          echo "y" | sudo ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install "ndk;25.2.9519653"
          echo "ANDROID_NDK_HOME=${ANDROID_HOME}/ndk/25.2.9519653" >> $GITHUB_ENV

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Build Android Binary
        run: cargo ndk -t aarch64-linux-android -p 21 build --release

      - name: Create Tarball & Checksum
        run: |
          mkdir -p dist/bundle
          # Copy the binary, keep name as 'portal' for internal use
          cp target/aarch64-linux-android/release/portal dist/bundle/portal
          cp README.md LICENSE* dist/bundle/ || true
          
          cd dist
          # Name the tarball to match the 'hiverra-portal' convention
          TAR_NAME="hiverra-portal-aarch64-linux-android.tar.gz"
          tar -cvzf "$TAR_NAME" -C bundle .
          sha256sum "$TAR_NAME" > "$TAR_NAME.sha256"
          cd ..

      - name: Generate Installer Script
        run: |
          cat > dist/portal-android-install.sh <<EOF
          #!/bin/sh
          set -e
          REPO="Spectra010s/portal"
          TAG="${{ github.ref_name }}"
          BINARY_NAME="hiverra-portal-aarch64-linux-android.tar.gz"
          URL="https://github.com/\$REPO/releases/download/\$TAG/\$BINARY_NAME"
          
          echo "Installing portal (\$TAG) for Android..."

          for cmd in curl tar sha256sum; do
              if ! command -v \$cmd >/dev/null 2>&1; then
                  pkg install -y \$cmd
              fi
          done

          TMP_DIR=\$(mktemp -d)
          FILE="\$TMP_DIR/package.tar.gz"

          curl -sSfL "\$URL" -o "\$FILE"

          echo "Verifying checksum..."
          curl -sSfL "\$URL.sha256" -o "\$TMP_DIR/check.sha256"
          EXPECTED_HASH=\$(awk '{print \$1}' "\$TMP_DIR/check.sha256")
          ACTUAL_HASH=\$(sha256sum "\$FILE" | awk '{print \$1}')

          if [ "\$EXPECTED_HASH" != "\$ACTUAL_HASH" ]; then
              echo "ERROR: Checksum mismatch!"
              exit 1
          fi

          tar -xzf "\$FILE" -C "\$TMP_DIR"
          mv "\$TMP_DIR/portal" "\$PREFIX/bin/portal"
          chmod +x "\$PREFIX/bin/portal"
          rm -rf "\$TMP_DIR"
          echo "Success! Type 'portal' to start."
          EOF

      - name: Wait for cargo-dist Release
        shell: bash
        run: |
          for i in {1..20}; do
            if gh release view ${{ github.ref_name }} > /dev/null 2>&1; then
              echo "Release found!"
              exit 0
            fi
            sleep 30
          done
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Everything
        run: gh release upload ${{ github.ref_name }} dist/hiverra-portal-aarch64-linux-android.tar.gz* dist/portal-android-install.sh --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Edit Release Body
        run: |
          gh release view ${{ github.ref_name }} --json body --jq '.body' > body.md

          # 1. Inject the Install Section under the standard shell script installer
          sed -i '/hiverra-portal-installer.sh | sh/a \
\
### Install prebuilt binaries via shell script (Android/Termux)\
\
```sh\
curl -lsSf [https://github.com/Spectra010s/portal/releases/download/$](https://github.com/Spectra010s/portal/releases/download/$){{ github.ref_name }}/portal-android-install.sh | sh\
```' body.md

          # 2. Inject the row into the Download Table
          sed -i '/unknown-linux-gnu.tar.xz/a | [hiverra-portal-aarch64-linux-android.tar.gz](https://github.com/Spectra010s/portal/releases/download/${{ github.ref_name }}/hiverra-portal-aarch64-linux-android.tar.gz) | Android (Termux) | [checksum](https://github.com/Spectra010s/portal/releases/download/${{ github.ref_name }}/hiverra-portal-aarch64-linux-android.tar.gz.sha256) |' body.md

          gh release edit ${{ github.ref_name }} --notes-file body.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
