name: Android Release
permissions:
  contents: write

on:
  push:
    tags:
      - '**[0-9]+.[0-9]+.[0-9]+*'

jobs:
  build-android:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: hiverra-portal
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Build Android Binary
        run: cargo ndk -t aarch64-linux-android --platform 28 build --release

      - name: Create Tarball & Checksum
        run: |
          mkdir -p dist/bundle
          cp target/aarch64-linux-android/release/portal dist/bundle/portal
          cp README.md LICENSE* dist/bundle/ || true
          
          cd dist
          TAR_NAME="hiverra-portal-aarch64-linux-android.tar.gz"
          tar -cvzf "$TAR_NAME" -C bundle .
          sha256sum "$TAR_NAME" > "$TAR_NAME.sha256"
          cd ..

      - name: Generate Installer Script
        run: |
          cat > dist/hiverra-portal-android-installer.sh <<EOF
          #!/bin/sh
          set -e
          REPO="Spectra010s/portal"
          TAG="${{ github.ref_name }}"
          BINARY_NAME="hiverra-portal-aarch64-linux-android.tar.gz"
          URL="https://github.com/\$REPO/releases/download/\$TAG/\$BINARY_NAME"
          
          echo "Installing portal (\$TAG) for Android..."

          # Check required tools before installing
          for cmd in curl tar sha256sum; do
              if ! command -v \$cmd >/dev/null 2>&1; then
                  echo "\$cmd not found. Installing..."
                  case "\$cmd" in
                      sha256sum)
                          pkg install -y coreutils
                          ;;
                      *)
                          pkg install -y "\$cmd"
                          ;;
                  esac
              fi
          done
          
          TMP_DIR=$(mktemp -d "$PREFIX/tmp/portal-install")
          FILE="\$TMP_DIR/hiverra-portal.tar.gz"

          echo "Downloading..."
          curl -sSfL "\$URL" -o "\$FILE"

          echo "Verifying checksum..."
          curl -sSfL "\$URL.sha256" -o "\$TMP_DIR/check.sha256"
          EXPECTED_HASH=\$(awk '{print \$1}' "\$TMP_DIR/check.sha256")
          ACTUAL_HASH=\$(sha256sum "\$FILE" | awk '{print \$1}')

          if [ "\$EXPECTED_HASH" != "\$ACTUAL_HASH" ]; then
              echo "ERROR: Checksum mismatch!"
              exit 1
          fi

          tar -xzf "\$FILE" -C "\$TMP_DIR"
          mv "\$TMP_DIR/portal" "\$PREFIX/bin/portal"
          chmod +x "\$PREFIX/bin/portal"
          rm -rf "\$TMP_DIR"
          echo "Success! Type 'portal' to start."
          EOF

      - name: Wait for cargo-dist Release
        shell: bash
        run: |
          for i in {1..20}; do
            if gh release view ${{ github.ref_name }} > /dev/null 2>&1; then
              echo "Release found!"
              exit 0
            fi
            sleep 30
          done
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Everything
        run: gh release upload ${{ github.ref_name }} dist/hiverra-portal-aarch64-linux-android.tar.gz* dist/hiverra-portal-android-installer.sh --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Edit Release Body
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REF: ${{ github.ref_name }}
        run: |
          # Fetch the current release notes
          gh release view "$REF" --json body --jq '.body' > body.md

          # Skip if Android section is already present
          if grep -q "Android / Termux" body.md; then
            echo "Android section already exists. Skipping edit."
            exit 0
          fi

          # Create temporary files for clean insertion
          cat > android_section.md <<'EOF'

          ### Install prebuilt binaries via shell script (Android / Termux)

          ```sh
          curl --proto '=https' --tlsv1.2 -LsSf \
            https://github.com/Spectra010s/portal/releases/download/$REF/hiverra-portal-android-installer.sh | sh
          ```

          Works in Termux (aarch64-linux-android target).
          EOF

          cat > table_row.md <<'EOF'
          hiverra-portal-aarch64-linux-android.tar.gz	Android (Termux)	[checksum](https://github.com/Spectra010s/portal/releases/download/$REF/hiverra-portal-aarch64-linux-android.tar.gz.sha256)
          EOF

          # Insert Android install section
          if grep -q "npm install hiverra-portal@" body.md; then
            # After npm install block
            sed -i "/npm install hiverra-portal@/r android_section.md" body.md
          elif grep -q "^Download .*Portal" body.md; then
            # Before "Download ..." heading + ensure blank line above it
            sed -i '/^Download .*Portal/i\
            ' body.md
            sed -i "/^Download .*Portal/r android_section.md" body.md
          else
            # Fallback: append at end with spacing
            printf '\n\n' >> body.md
            cat android_section.md >> body.md
          fi

          # Insert table row exactly once
          # First remove any previous (possibly broken) Android row
          sed -i '/aarch64-linux-android\.tar\.gz/d' body.md

          if grep -q "x86_64-unknown-linux-gnu\.tar\.xz" body.md; then
            sed -i "/x86_64-unknown-linux-gnu\.tar\.xz/r table_row.md" body.md
          elif grep -q "^---" body.md; then
            sed -i "/^---/r table_row.md" body.md
          else
            printf '\n' >> body.md
            cat table_row.md >> body.md
          fi

          # Apply the updated notes
          gh release edit "$REF" --notes-file body.md

          # Clean up temp files
          rm -f android_section.md table_row.md
