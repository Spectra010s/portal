name: Android Release
permissions:
  contents: write

on:
  push:
    tags:
      - '**[0-9]+.[0-9]+.[0-9]+*'

jobs:
  build-android:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: hiverra-portal
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Build Android Binary
        run: cargo ndk -t aarch64-linux-android --platform 28 build --release

      - name: Create Tarball & Checksum
        run: |
          mkdir -p dist/bundle
          cp target/aarch64-linux-android/release/portal dist/bundle/portal
          cp README.md LICENSE* dist/bundle/ || true
          
          cd dist
          TAR_NAME="hiverra-portal-aarch64-linux-android.tar.gz"
          tar -cvzf "$TAR_NAME" -C bundle .
          sha256sum "$TAR_NAME" > "$TAR_NAME.sha256"
          cd ..

      - name: Generate Installer Script
        run: |
          cat > dist/hiverra-portal-android-installer.sh <<EOF
          #!/bin/sh
          set -e
          REPO="Spectra010s/portal"
          TAG="${{ github.ref_name }}"
          BINARY_NAME="hiverra-portal-aarch64-linux-android.tar.gz"
          URL="https://github.com/\$REPO/releases/download/\$TAG/\$BINARY_NAME"
          
          echo "Installing portal (\$TAG) for Android..."

          # Check required tools before installing
          for cmd in curl tar sha256sum; do
              if ! command -v \$cmd >/dev/null 2>&1; then
                  echo "\$cmd not found. Installing..."
                  case "\$cmd" in
                      sha256sum)
                          pkg install -y coreutils
                          ;;
                      *)
                          pkg install -y "\$cmd"
                          ;;
                  esac
              fi
          done
          
          TMP_DIR=$(mktemp -d "$PREFIX/tmp/portal.XXXXXX")
          FILE="\$TMP_DIR/hiverra-portal.tar.gz"

          echo "Downloading..."
          curl -sSfL "\$URL" -o "\$FILE"

          echo "Verifying checksum..."
          curl -sSfL "\$URL.sha256" -o "\$TMP_DIR/check.sha256"
          EXPECTED_HASH=\$(awk '{print \$1}' "\$TMP_DIR/check.sha256")
          ACTUAL_HASH=\$(sha256sum "\$FILE" | awk '{print \$1}')

          if [ "\$EXPECTED_HASH" != "\$ACTUAL_HASH" ]; then
              echo "ERROR: Checksum mismatch!"
              exit 1
          fi

          tar -xzf "\$FILE" -C "\$TMP_DIR"
          mv "\$TMP_DIR/portal" "\$PREFIX/bin/portal"
          chmod +x "\$PREFIX/bin/portal"
          rm -rf "\$TMP_DIR"
          echo "Success! Type 'portal' to start."
          EOF

      - name: Wait for cargo-dist Release
        shell: bash
        run: |
          for i in {1..20}; do
            if gh release view ${{ github.ref_name }} > /dev/null 2>&1; then
              echo "Release found!"
              exit 0
            fi
            sleep 30
          done
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Everything
        run: gh release upload ${{ github.ref_name }} dist/hiverra-portal-aarch64-linux-android.tar.gz* dist/hiverra-portal-android-installer.sh --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Edit Release Body
        run: |
          gh release view ${{ github.ref_name }} --json body --jq '.body' > body.md

          if ! grep -q "Android/Termux" body.md; then
            cat > android_sh.txt <<EOF

            ### Install prebuilt binaries via shell script (Android/Termux)
            
            \`\`\`sh
            curl -sSfL https://github.com/Spectra010s/portal/releases/download/${{ github.ref_name }}/hiverra-portal-android-installer.sh | sh
            \`\`\`
            EOF
            sed -i "/### Install prebuilt binaries via powershell script/r android_sh.txt" body.md
          fi

          ANDROID_ROW="| [hiverra-portal-aarch64-linux-android.tar.gz](https://github.com/Spectra010s/portal/releases/download/${{ github.ref_name }}/hiverra-portal-aarch64-linux-android.tar.gz) | Android (Termux) | [checksum](https://github.com/Spectra010s/portal/releases/download/${{ github.ref_name }}/hiverra-portal-aarch64-linux-android.tar.gz.sha256) |"

          if ! grep -q "aarch64-linux-android.tar.gz" body.md; then
            sed -i "/unknown-linux-gnu.tar.xz/a $ANDROID_ROW" body.md
          fi

          gh release edit ${{ github.ref_name }} --notes-file body.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}